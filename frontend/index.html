<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MEP Bracket Tool</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0b1220;color:#e6eefc}
    .wrap{display:flex;min-height:100vh}
    .side{width:280px;background:#0f1a33;border-right:1px solid rgba(255,255,255,.08);padding:14px;box-sizing:border-box}
    .main{flex:1;padding:16px;box-sizing:border-box}
    .card{background:#101c3a;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:#2a6df5;border:none;color:white;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b1734;color:#e6eefc}
    label{display:block;font-size:12px;opacity:.85;margin:8px 0 6px}
    .muted{opacity:.75;font-size:12px}
    .tabs{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .tab{padding:10px 10px;border-radius:10px;cursor:pointer;border:1px solid rgba(255,255,255,.08);background:#0b1734}
    .tab.active{background:#152a5a;border-color:rgba(255,255,255,.18)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0b1734;border:1px solid rgba(255,255,255,.10)}
    pre{white-space:pre-wrap;background:#08122a;border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:10px}
    svg{width:100%;height:auto;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:#0b1734}
  </style>
</head>
<body>
<div class="wrap">
  <div class="side">
    <div style="font-weight:900;font-size:16px">MEP Bracket Tool</div>
    <div class="muted">Trapeze (v2 UI) – library dropdowns enabled</div>

    <div class="card" style="margin-top:12px">
      <div class="row">
        <div style="flex:1">
          <label>API Base URL</label>
          <input id="apiBase" placeholder="http://192.168.10.181:8000" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="saveApiBtn">Save API</button>
      </div>
      <div class="muted" style="margin-top:8px">Tip: default uses this page’s hostname on port 8000.</div>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">Login</div>
      <label>Email</label>
      <input id="email" placeholder="you@company.com" />
      <label>Password</label>
      <input id="password" type="password" />
      <div class="row" style="margin-top:10px">
        <button class="btn" id="loginBtn">Login</button>
        <button class="btn" id="logoutBtn" style="background:#415a8b">Logout</button>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="pill" id="authPill">Not logged in</div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">Projects</div>
      <label>Project</label>
      <select id="projectSelect">
        <option value="">Select project…</option>
      </select>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="refreshProjectsBtn" style="background:#415a8b">Refresh</button>
      </div>

      <div style="margin-top:12px;border-top:1px solid rgba(255,255,255,.08);padding-top:12px">
        <div class="muted">Create new</div>
        <label>Name</label>
        <input id="projName" placeholder="e.g. Level 2 Corridor Trapeze" />
        <label>Bracket reference</label>
        <input id="projRef" placeholder="e.g. BKT001" />
        <div class="row" style="margin-top:10px">
          <button class="btn" id="createProjectBtn" style="background:#22a06b">Create</button>
        </div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="Define Bracket">Define Bracket</div>
      <div class="tab" data-tab="Add Loads">Add Loads</div>
      <div class="tab" data-tab="Output">Output</div>
      <div class="tab" data-tab="Debug">Debug</div>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
      <div>
        <div style="font-size:18px;font-weight:900" id="pageTitle">Define Bracket</div>
        <div class="muted" id="projectMeta">No project selected</div>
      </div>
      <div class="pill" id="statusPill">Idle</div>
    </div>

    <div id="content" style="margin-top:12px"></div>
  </div>
</div>

<script>
  const LS_API="mep_api_base";
  const LS_TOKEN="mep_token";

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  const state = {
    project: null,
    tab: "Define Bracket",
    bracket: {
      bracket_ref: "BKT-001",
      span_mm: 1200,
      tier_count: 1,
      fire_condition: false,
      profile_id: "GEN_41x41",
      rod_id: "GEN_M10",
      washer_id: "GEN_PENNY_M10",
      anchor_id: "GEN_STEEL_M10",
    },
    library: {
      profiles: [],
      rods: [],
      washers: [],
      anchors: []
    },
    loads: {
      1: [1500],
      2: [],
      3: []
    },
    lastResult: null,
    debounceTimer: null,
    debug: {},
  };

  function setDebug(obj){
    state.debug = Object.assign({}, state.debug, obj);
  }

  function defaultApi(){
    return `${location.protocol}//${location.hostname}:8000`;
  }

  function apiBase(){
    return localStorage.getItem(LS_API) || defaultApi();
  }

  function token(){
    return localStorage.getItem(LS_TOKEN) || "";
  }

  function isAuthed(){
    return !!token();
  }

  async function apiFetch(path, opts={}){
    const headers = opts.headers || {};
    if(isAuthed()){
      headers["Authorization"] = `Bearer ${token()}`;
    }
    const r = await fetch(apiBase()+path, Object.assign({}, opts, {headers}));
    let body=null;
    try{ body = await r.json(); }catch(e){ body=null; }
    return {r, body};
  }

  function syncAuthPill(){
    document.getElementById("authPill").textContent = isAuthed() ? "Logged in" : "Not logged in";
  }

  function setStatus(text){
    document.getElementById("statusPill").textContent = text;
  }

  async function login(){
    setStatus("Logging in…");
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const {r, body} = await apiFetch("/auth/login", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({email, password})
    });
    if(!r.ok){
      alert(body?.detail || "Login failed");
      setStatus("Idle");
      return;
    }
    localStorage.setItem(LS_TOKEN, body.access_token);
    syncAuthPill();
    await refreshProjects();
    await loadLibrary();
    render();
    setStatus("Idle");
  }

  function logout(){
    localStorage.removeItem(LS_TOKEN);
    state.project = null;
    state.lastResult = null;
    syncAuthPill();
    render();
  }

  async function refreshProjects(){
    if(!isAuthed()) return;
    const {r, body} = await apiFetch("/projects");
    if(!r.ok){
      alert(body?.detail || "Failed to load projects");
      return;
    }
    const items = Array.isArray(body) ? body : (body?.items || []);
    const sel = document.getElementById("projectSelect");
    const cur = sel.value;
    sel.innerHTML = '<option value="">Select project…</option>';
    items.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      const ref = p.bracket_reference || p.project_ref || "—";
      const name = p.name || p.id;
      opt.textContent = `${ref} · ${name}`;
      sel.appendChild(opt);
    });
    if(cur) sel.value = cur;
    setDebug({projects: items.length});
  }

  async function createProject(){
    if(!isAuthed()){ alert("Login first"); return; }
    const name = document.getElementById("projName").value.trim() || "Untitled";
    const bracket_reference = document.getElementById("projRef").value.trim() || "BKT001";
    const {r, body} = await apiFetch("/projects", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({name, bracket_reference})
    });
    if(!r.ok){
      alert(body?.detail || "Failed to create project");
      return;
    }
    await refreshProjects();
    document.getElementById("projectSelect").value = body.id;
    await selectProject(body.id);
  }

  async function selectProject(id){
    if(!id){
      state.project = null;
      state.lastResult = null;
      render();
      return;
    }
    state.project = {id};
    setStatus("Loading…");
    const {r, body} = await apiFetch(`/projects/${id}`);
    if(r.ok && body){
      // Backend returns snapshot JSON; merge into bracket/loads if present
      // (Snapshot schema can vary; be defensive)
      state.bracket = Object.assign({}, state.bracket, body);
      if(body.loads) state.loads = body.loads;
    }
    setStatus("Idle");
    render();
    scheduleCheck();
  }

  async function loadLibrary(){
    if(!isAuthed()) return;

    async function load(kind){
      const {r, body} = await apiFetch(`/library/${kind}`);
      if(!r.ok) return [];
      return body?.items || [];
    }

    state.library.profiles = await load("profiles");
    state.library.rods     = await load("rods");
    state.library.washers  = await load("washers");
    state.library.anchors  = await load("anchors");
  }

  function optionsFrom(items, valueKey, labelFn, selected){
    const opts = (items || []).map(it=>{
      const v = String(it[valueKey] ?? "");
      const label = labelFn(it);
      const sel = (v === String(selected)) ? "selected" : "";
      return `<option value="${escapeHtml(v)}" ${sel}>${escapeHtml(label)}</option>`;
    }).join("");
    return `<option value="">Select…</option>` + opts;
  }

  function scheduleCheck(){
    if(!state.project?.id) return;
    clearTimeout(state.debounceTimer);
    state.debounceTimer = setTimeout(runCheck, 350);
  }

  async function runCheck(){
    if(!state.project?.id) return;
    setStatus("Checking…");

    // Build a snapshot payload for the backend by updating project snapshot first
    // Your current backend uses stored snapshot, not request body, so we update it via "create project snapshot" pattern later.
    // For now we call /check which uses stored snapshot; this UI mainly proves dropdown wiring + future-ready.
    const {r, body} = await apiFetch(`/projects/${state.project.id}/check`, {method:"POST"});
    if(!r.ok){
      setStatus("Idle");
      state.lastResult = {error: body?.detail || "Check failed"};
      render();
      return;
    }
    state.lastResult = body;
    setStatus(body.status || "OK");
    render();
  }

  function drawSvg(){
    const span = Number(state.bracket.span_mm || 1200);
    const tiers = Number(state.bracket.tier_count || 1);
    const w = 900, h = 280;
    const pad = 60;
    const x1 = pad, x2 = w - pad;
    const y0 = 70;
    const tierGap = 55;

    const tierYs = [];
    for(let i=0;i<tiers;i++){
      tierYs.push(y0 + i*tierGap);
    }

    const loads = state.loads;
    function tierLoad(i){
      const arr = loads[i] || [];
      return arr.reduce((a,b)=>a+Number(b||0),0);
    }

    const lines = tierYs.map((y, idx) => {
      const t = idx+1;
      const L = tierLoad(t);
      return `
        <line x1="${x1}" y1="${y}" x2="${x2}" y2="${y}" stroke="rgba(255,255,255,.9)" stroke-width="5" />
        <text x="${x2+10}" y="${y+5}" fill="rgba(255,255,255,.9)" font-size="14">Tier ${t}: ${L} N</text>
      `;
    }).join("");

    return `
      <svg viewBox="0 0 ${w} ${h}">
        <text x="${pad}" y="28" fill="rgba(255,255,255,.9)" font-size="16" font-weight="700">
          Span: ${span} mm · Tiers: ${tiers}
        </text>
        <line x1="${x1}" y1="${y0-40}" x2="${x1}" y2="${tierYs[tierYs.length-1]+40}" stroke="rgba(255,255,255,.4)" stroke-width="6"/>
        <line x1="${x2}" y1="${y0-40}" x2="${x2}" y2="${tierYs[tierYs.length-1]+40}" stroke="rgba(255,255,255,.4)" stroke-width="6"/>
        ${lines}
      </svg>
    `;
  }

  function render(){
    document.getElementById("pageTitle").textContent = state.tab;
    if(state.project?.id){
      document.getElementById("projectMeta").textContent = `Project: ${state.project.id}`;
    } else {
      document.getElementById("projectMeta").textContent = `No project selected`;
    }

    document.querySelectorAll(".tab").forEach(el=>{
      el.classList.toggle("active", el.dataset.tab === state.tab);
    });

    const c = document.getElementById("content");

    if(state.tab === "Define Bracket"){
      c.innerHTML = `
        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Define Bracket</div>

          <div class="row">
            <div style="flex:1">
              <label>Bracket Ref</label>
              <input id="bracket_ref" value="${escapeHtml(state.bracket.bracket_ref)}" />
            </div>
            <div style="flex:1">
              <label>Span (mm)</label>
              <input id="span_mm" type="number" value="${escapeHtml(state.bracket.span_mm)}" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Tier Count</label>
              <select id="tier_count">
                <option value="1" ${state.bracket.tier_count==1?"selected":""}>1</option>
                <option value="2" ${state.bracket.tier_count==2?"selected":""}>2</option>
                <option value="3" ${state.bracket.tier_count==3?"selected":""}>3</option>
              </select>
            </div>
            <div style="flex:1">
              <label>Fire Condition</label>
              <select id="fire_condition">
                <option value="false" ${!state.bracket.fire_condition?"selected":""}>No</option>
                <option value="true" ${state.bracket.fire_condition?"selected":""}>Yes</option>
              </select>
            </div>
          </div>

          <label>Profile</label>
          <select id="profile_id">
            ${optionsFrom(
              state.library.profiles,
              "profile_id",
              p => `${p.profile_id} · ${p.profile_name} (${p.width_mm}x${p.height_mm}x${p.thickness_mm})`,
              state.bracket.profile_id
            )}
          </select>

          <label>Rod</label>
          <select id="rod_id">
            ${optionsFrom(
              state.library.rods,
              "rod_id",
              r => `${r.rod_id} · ${r.rod_name || r.thread || "Rod"}`,
              state.bracket.rod_id
            )}
          </select>

          <label>Washer</label>
          <select id="washer_id">
            ${optionsFrom(
              state.library.washers,
              "washer_id",
              w => `${w.washer_id} · ${w.washer_name} (x${w.bearing_area_multiplier || 1})`,
              state.bracket.washer_id
            )}
          </select>

          <label>Anchor</label>
          <select id="anchor_id">
            ${optionsFrom(
              state.library.anchors,
              "anchor_id",
              a => `${a.anchor_id} · ${a.anchor_name || a.base_material || "Anchor"}`,
              state.bracket.anchor_id
            )}
          </select>

          <div class="row" style="margin-top:12px">
            <button class="btn" id="toLoadsBtn" style="background:#415a8b">Next: Add Loads</button>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Preview</div>
          ${drawSvg()}
          <div class="muted" style="margin-top:8px">Live drawing updates as you change tier count/span.</div>
        </div>
      `;

      wireDefine();
      return;
    }

    if(state.tab === "Add Loads"){
      const tiers = Number(state.bracket.tier_count || 1);
      let html = `
        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Add Loads (N)</div>
          <div class="muted">Enter one or more loads per tier (N). This is placeholder until duct/pipe weights are integrated.</div>
      `;

      for(let t=1;t<=tiers;t++){
        const arr = state.loads[t] || [];
        html += `
          <div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(255,255,255,.08)">
            <div style="font-weight:800">Tier ${t}</div>
            <div class="row" style="margin-top:8px;align-items:flex-end">
              <div style="flex:1">
                <label>Loads (comma separated)</label>
                <input id="tier_${t}" value="${escapeHtml(arr.join(","))}" />
              </div>
            </div>
          </div>
        `;
      }

      html += `
          <div class="row" style="margin-top:12px">
            <button class="btn" id="runCheckBtn">Run Check</button>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Preview</div>
          ${drawSvg()}
        </div>
      `;

      c.innerHTML = html;
      wireLoads();
      return;
    }

    if(state.tab === "Output"){
      c.innerHTML = `
        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Result</div>
          <pre>${escapeHtml(JSON.stringify(state.lastResult || {info:"Run a check to see results"}, null, 2))}</pre>
          <div class="muted">PDF output wiring comes next (after check engine is non-placeholder).</div>
        </div>
      `;
      return;
    }

    if(state.tab === "Debug"){
      c.innerHTML = `
        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Debug</div>
          <div class="muted">API Base: ${escapeHtml(apiBase())}</div>
          <div class="muted">Authed: ${isAuthed() ? "yes" : "no"}</div>
          <pre>${escapeHtml(JSON.stringify(state.debug, null, 2))}</pre>
        </div>
      `;
      return;
    }
  }

  function wireDefine(){
    const el = (id) => document.getElementById(id);

    el("toLoadsBtn").onclick = ()=>{ state.tab="Add Loads"; render(); };

    const bind = (id, fn) => {
      el(id).addEventListener("input", ()=>{ fn(el(id).value); render(); scheduleCheck(); });
      el(id).addEventListener("change", ()=>{ fn(el(id).value); render(); scheduleCheck(); });
    };

    bind("bracket_ref", v => state.bracket.bracket_ref = v);
    bind("span_mm", v => state.bracket.span_mm = Number(v||0));
    bind("tier_count", v => state.bracket.tier_count = Number(v||1));
    bind("fire_condition", v => state.bracket.fire_condition = (String(v) === "true"));

    bind("profile_id", v => state.bracket.profile_id = String(v||""));
    bind("rod_id", v => state.bracket.rod_id = String(v||""));
    bind("washer_id", v => state.bracket.washer_id = String(v||""));
    bind("anchor_id", v => state.bracket.anchor_id = String(v||""));
  }

  function wireLoads(){
    const tiers = Number(state.bracket.tier_count || 1);
    for(let t=1;t<=tiers;t++){
      const inp = document.getElementById(`tier_${t}`);
      inp.addEventListener("input", ()=>{
        const parts = inp.value.split(",").map(s=>s.trim()).filter(Boolean).map(x=>Number(x));
        state.loads[t] = parts.filter(n=>Number.isFinite(n));
        render();
        scheduleCheck();
      });
    }
    document.getElementById("runCheckBtn").onclick = ()=>runCheck();
  }

  // ---- Side UI wiring ----
  document.getElementById("apiBase").value = apiBase();
  document.getElementById("saveApiBtn").onclick = ()=>{
    const v = document.getElementById("apiBase").value.trim() || defaultApi();
    localStorage.setItem(LS_API, v);
    alert("Saved API Base: " + v);
  };

  document.getElementById("loginBtn").onclick = login;
  document.getElementById("logoutBtn").onclick = logout;
  document.getElementById("refreshProjectsBtn").onclick = refreshProjects;
  document.getElementById("createProjectBtn").onclick = createProject;

  document.getElementById("projectSelect").addEventListener("change", (e)=>{
    selectProject(e.target.value);
  });

  document.querySelectorAll(".tab").forEach(el=>{
    el.addEventListener("click", ()=>{
      state.tab = el.dataset.tab;
      render();
    });
  });

  // ---- init ----
  syncAuthPill();
  // auto-load if already authed
  (async ()=>{
    if(isAuthed()){
      await refreshProjects();
      await loadLibrary();
    }
    render();
  })();

</script>
</body>
</html>
